<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SoundCloud Web Player 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 2025 Design System --- */
        
         :root {
            --bg-deep: #09090b;
            --bg-card: rgba(24, 24, 27, 0.6);
            --bg-card-hover: rgba(39, 39, 42, 0.8);
            --primary-gradient: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            --primary-color: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.5);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --border-light: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* Mesh Gradient Background */
            background-image: radial-gradient(circle at 15% 50%, rgba(124, 58, 237, 0.15), transparent 25%), radial-gradient(circle at 85% 30%, rgba(79, 70, 229, 0.15), transparent 25%);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        /* Custom Scrollbar */
        
         ::-webkit-scrollbar {
            width: 6px;
        }
        
         ::-webkit-scrollbar-track {
            background: transparent;
        }
        
         ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
         ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 140px;
            /* Space for floating player */
            position: relative;
            z-index: 10;
        }
        /* Card / Glass Styles */
        
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        /* Inputs & Forms */
        
        .form-input,
        .form-select {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid var(--border-light) !important;
            color: white !important;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        /* Buttons */
        
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.5);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(5px);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        /* Tabs (Segmented Control) */
        
        .nav-tabs-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            display: flex;
            gap: 4px;
        }
        
        .main-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }
        
        .main-tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .main-tab:hover:not(.active) {
            color: white;
        }
        /* Track Items */
        
        .track-item,
        .playlist-track-item,
        .favorite-track-item,
        .history-track-item,
        .queue-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: 12px;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }
        
        .track-item:hover,
        .playlist-track-item:hover,
        .favorite-track-item:hover,
        .history-track-item:hover,
        .queue-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }
        
        .track-item.active,
        .playlist-track-item.active,
        .favorite-track-item.active,
        .history-track-item.active {
            background: rgba(139, 92, 246, 0.15) !important;
            border-color: var(--primary-color) !important;
        }
        
        .track-item.active p,
        .playlist-track-item.active p,
        .favorite-track-item.active p,
        .history-track-item.active p {
            color: #c4b5fd !important;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        /* Persistent Player (Glass & Floating) */
        
        #persistent-player-container {
            position: fixed;
            bottom: 20px;
            /* Floating look */
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            width: calc(100% - 32px);
            max-width: 700px;
            z-index: 50;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #persistent-player-container.show {
            transform: translateX(-50%) translateY(0);
        }
        /* Minimized Player */
        
        #minimized-player {
            background: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 12px;
        }
        /* Expanded Player (Full Screen) */
        
        #persistent-player-container.expanded {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            transform: translateY(0);
            border-radius: 0;
            background: linear-gradient(to bottom, #1e1b4b, #09090b);
            z-index: 100;
        }
        
        #expanded-player {
            display: none;
            /* Logic controlled by JS */
            background: radial-gradient(circle at top center, rgba(124, 58, 237, 0.2), transparent 70%);
        }
        
        #persistent-player-container.expanded #minimized-player {
            display: none;
        }
        
        #persistent-player-container.expanded #expanded-player {
            display: flex;
        }
        /* Progress Bar */
        
        .progress-bar-container {
            background-color: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 4px;
            overflow: visible;
            transition: height 0.2s;
        }
        
        .progress-bar-container:hover {
            height: 6px;
        }
        
        .progress-bar-filled {
            background: var(--primary-gradient);
            height: 100%;
            border-radius: 4px;
            box-shadow: 0 0 10px var(--primary-glow);
            position: relative;
        }
        
        .progress-bar-filled::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .progress-bar-container:hover .progress-bar-filled::after {
            opacity: 1;
        }
        /* Volume Slider */
        
        .volume-slider {
            -webkit-appearance: none;
            background: transparent;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        /* Controls */
        
        .player-controls button {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s;
        }
        
        .player-controls button:active {
            transform: scale(0.9);
        }
        
        #player-play-pause-btn-expanded {
            background: white;
            color: black;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        
        #player-play-pause-btn-expanded:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        /* Modals */
        
        .modal {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            background: #18181b;
            border: 1px solid var(--border-light);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border-radius: var(--radius-xl);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalPop {
            from {
                transform: scale(0.95) translateY(10px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        /* Context Menu */
        
        .context-menu {
            background: rgba(24, 24, 27, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 4px;
        }
        
        .context-menu-item {
            border-radius: 6px;
        }
        
        .context-menu-item:hover {
            background: var(--primary-color);
            color: white;
        }
        /* Animations */
        
        @keyframes pulse-glow {
            0%,
            100% {
                box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
            }
            50% {
                box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
            }
        }
        
        .loading-track {
            animation: pulse 1.5s infinite;
        }
        /* Album Art Shadow */
        
        #player-thumb-expanded {
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tab Buttons in Player */
        
        .tab-button {
            position: relative;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .tab-button.active {
            color: white;
            border-bottom: none;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
            box-shadow: 0 0 10px var(--primary-color);
        }
        /* Dragging state */
        
        .queue-item.dragging {
            background: rgba(139, 92, 246, 0.2);
            border: 1px dashed var(--primary-color);
            opacity: 0.8;
        }
        /* Tooltip */
        
        .tooltip::after {
            background: rgba(255, 255, 255, 0.9);
            color: black;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        /* Switch */
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked+.slider {
            background-color: var(--primary-color);
        }
        
        input:checked+.slider:before {
            transform: translateX(22px);
        }
        /* Utility Helpers */
        
        .text-gradient {
            background: linear-gradient(to right, #a78bfa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .empty-state i {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="antialiased selection:bg-purple-500 selection:text-white">
    <!-- Background glow effects -->
    <div class="fixed top-0 left-0 w-full h-full pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-900/20 rounded-full blur-[100px]"></div>
    </div>

    <div id="main-content">
        <div class="container mx-auto p-4 max-w-2xl relative z-10 pt-8">
            <div class="text-center mb-8">
                <div class="inline-block p-3 rounded-full bg-white/5 backdrop-blur-md border border-white/10 mb-4 shadow-xl">
                    <i class="fab fa-soundcloud text-4xl text-gradient"></i>
                </div>
                <h1 class="text-4xl font-bold tracking-tight text-white mb-2">SoundCloud
                    <span class="text-gradient">Player</span></h1>
                <p class="text-sm text-gray-400 font-medium">Stream high-quality audio instantly</p>
            </div>

            <!-- Main Navigation Tabs - Segmented Control Style -->
            <div class="nav-tabs-container mb-6">
                <button class="main-tab flex-1 active" data-tab="search"><i
                            class="fas fa-search mr-2"></i>Search</button>
                <button class="main-tab flex-1" data-tab="favorites"><i
                            class="fas fa-heart mr-2"></i>Favorites</button>
                <button class="main-tab flex-1" data-tab="playlists"><i
                            class="fas fa-list mr-2"></i>Playlists</button>
                <button class="main-tab flex-1" data-tab="history"><i
                            class="fas fa-clock mr-2"></i>History</button>
            </div>

            <!-- Search Tab Content -->
            <div id="search-tab" class="tab-content">
                <div class="glass-panel p-2 mb-6 flex gap-2">
                    <input id="sc-url-input" type="text" placeholder="Paste SoundCloud Link..." class="bg-transparent border-none text-white w-full px-4 py-3 focus:outline-none placeholder-gray-500 font-medium">
                    <button id="fetch-btn" class="btn-primary font-semibold py-2 px-6 rounded-lg whitespace-nowrap flex items-center justify-center gap-2 shadow-lg hover:shadow-purple-500/30">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                </div>

                <!-- Search History -->
                <div id="search-history" class="mb-6 hidden">
                    <div class="flex justify-between items-center mb-3 px-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500">Recent</h3>
                        <button id="clear-history" class="text-xs text-purple-400 hover:text-purple-300 font-medium">Clear
                                All</button>
                    </div>
                    <div id="history-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div id="loader" class="text-center my-12 hidden">
                    <div class="relative w-16 h-16 mx-auto">
                        <div class="absolute inset-0 border-4 border-purple-500/30 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-purple-500 rounded-full border-t-transparent animate-spin"></div>
                    </div>
                    <p class="mt-4 text-gray-400 animate-pulse">Fetching tracks...
                    </p>
                </div>

                <div id="error-display" class="bg-red-500/10 border border-red-500/20 backdrop-blur-md text-red-200 p-4 rounded-xl my-4 hidden flex items-start gap-3">
                    <div class="bg-red-500/20 p-2 rounded-full"><i class="fas fa-exclamation-triangle"></i></div>
                    <span id="error-message" class="mt-1 font-medium"></span>
                </div>

                <div id="playlist-header" class="mt-6 mb-4 hidden px-2"></div>
                <div id="playlist-container" class="space-y-2 pb-20"></div>
            </div>

            <!-- Favorites Tab Content -->
            <div id="favorites-tab" class="tab-content hidden">
                <div id="favorites-container" class="space-y-2 pb-20">
                    <div class="empty-state py-12 flex flex-col items-center">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-heart text-3xl opacity-50"></i>
                        </div>
                        <p class="font-medium text-lg">No favorites yet</p>
                        <p class="text-sm text-gray-500 mt-2">Like songs to see them here</p>
                    </div>
                </div>
            </div>

            <!-- Playlists Tab Content -->
            <div id="playlists-tab" class="tab-content hidden">
                <button id="create-playlist-btn" class="create-playlist-btn w-full mb-6 btn-primary py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> New Playlist
                    </button>
                <div id="playlists-container" class="space-y-3 pb-20">
                    <div class="empty-state py-12 flex flex-col items-center">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-list-music text-3xl opacity-50"></i>
                        </div>
                        <p class="font-medium text-lg">Your library is empty
                        </p>
                        <p class="text-sm text-gray-500 mt-2">Create playlists to organize your vibe</p>
                    </div>
                </div>
            </div>

            <!-- History Tab Content -->
            <div id="history-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h2 class="text-lg font-bold">Recently Played</h2>
                    <button id="clear-playback-history" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition-colors">Clear</button>
                </div>
                <div id="history-tracks-container" class="space-y-2 pb-20">
                    <div class="empty-state py-12 flex flex-col items-center">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-history text-3xl opacity-50"></i>
                        </div>
                        <p class="font-medium text-lg">No playback history
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-8 mb-4 text-center text-sm text-gray-500 relative z-10">
            <div class="flex justify-center gap-6 mb-4">
                <a href="https://t.me/yebekhe" target="_blank" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all transform hover:-translate-y-1">
                    <i class="fab fa-telegram-plane text-lg"></i>
                </a>
                <a href="https://twitter.com/yebekhe" target="_blank" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-black hover:text-white transition-all transform hover:-translate-y-1">
                    <i class="fab fa-x-twitter text-lg"></i>
                </a>
                <a href="https://github.com/itsyebekhe/soundcloud/" target="_blank" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-purple-600 hover:text-white transition-all transform hover:-translate-y-1">
                    <i class="fab fa-github text-lg"></i>
                </a>
            </div>
            <p class="opacity-60">Designed with ❤️ • YEBEKHE</p>
        </footer>
    </div>

    <!-- Player Container - Floating Glass Bar Style -->
    <div id="persistent-player-container">
        <!-- Minimized Player View -->
        <div id="minimized-player" class="cursor-pointer relative overflow-hidden group">
            <!-- Progress bar overlay on bottom of mini player -->
            <div class="absolute bottom-0 left-0 w-full h-[2px] bg-white/10">
                <div id="mini-progress-bar" class="h-full bg-purple-500 w-0"></div>
                <!-- Requires JS hook or reuse main progress bar logic visually -->
            </div>

            <div class="flex items-center gap-3">
                <div class="relative group-hover:scale-105 transition-transform duration-300">
                    <img id="player-thumb-mini" class="w-12 h-12 rounded-lg shadow-lg object-cover bg-gray-800">
                    <div id="player-loading-indicator" class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-lg hidden backdrop-blur-sm">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </div>
                <div class="flex-grow min-w-0 flex flex-col justify-center">
                    <p id="player-title-mini" class="font-bold text-sm truncate text-white leading-tight"></p>
                    <p id="player-performer-mini" class="text-xs truncate text-gray-400 mt-0.5"></p>
                </div>
                <div class="flex items-center gap-3 text-lg pr-1">
                    <button id="player-favorite-btn-mini" class="favorite-btn w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors tooltip" data-tooltip="Favorite">
                            <i class="far fa-heart text-sm"></i>
                        </button>
                    <button id="player-play-pause-btn-mini" class="w-10 h-10 flex items-center justify-center bg-white text-black rounded-full hover:scale-105 transition-transform shadow-lg"></button>
                </div>
            </div>
        </div>

        <!-- Expanded Player View -->
        <div id="expanded-player" class="p-6 pt-12 max-w-2xl mx-auto w-full h-full flex flex-col relative">

            <!-- Drag Indicator for mobile feel -->
            <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-12 h-1 bg-white/20 rounded-full"></div>

            <button id="minimize-btn" class="absolute top-6 left-6 w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-colors z-20">
                    <i class="fas fa-chevron-down text-white"></i>
                </button>

            <div class="w-full flex justify-center mb-6 px-12">
                <div class="flex bg-black/20 p-1 rounded-xl backdrop-blur-sm">
                    <button class="tab-button px-4 py-1.5 text-sm rounded-lg active" data-tab="now-playing">Playing</button>
                    <button class="tab-button px-4 py-1.5 text-sm rounded-lg" data-tab="queue">Queue</button>
                    <button class="tab-button px-4 py-1.5 text-sm rounded-lg" data-tab="settings">Config</button>
                </div>
            </div>

            <!-- Now Playing Content -->
            <div id="now-playing-tab" class="tab-content w-full flex flex-col items-center justify-center flex-grow h-full">
                <div class="relative mb-8 w-full max-w-[320px] aspect-square">
                    <img id="player-thumb-expanded" class="w-full h-full object-cover rounded-3xl bg-gray-800 ring-1 ring-white/10">
                    <div id="player-loading-indicator-expanded" class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-3xl hidden backdrop-blur-md">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
                    </div>
                </div>

                <div class="w-full mb-8 px-4 flex items-end justify-between">
                    <div class="flex-1 min-w-0 pr-4">
                        <h2 id="player-title-expanded" class="text-2xl font-bold truncate text-white leading-tight"></h2>
                        <p id="player-performer-expanded" class="text-lg text-gray-400 mt-1 truncate font-medium"></p>
                    </div>
                    <div class="flex gap-2">
                        <button id="player-favorite-btn-expanded" class="favorite-btn w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-xl tooltip" data-tooltip="Favorite">
                                <i class="far fa-heart"></i>
                            </button>
                        <button id="player-share-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-xl tooltip" data-tooltip="Share">
                                <i class="fas fa-share-alt"></i>
                            </button>
                    </div>
                </div>

                <!-- Progress & Time -->
                <div class="w-full px-4 mb-6">
                    <div id="progress-container" class="progress-bar-container w-full mb-2 cursor-pointer group">
                        <div id="player-progress-bar" class="progress-bar-filled w-0"></div>
                    </div>
                    <div class="flex justify-between text-xs font-mono text-gray-400 font-medium">
                        <span id="player-current-time">0:00</span>
                        <span id="player-total-duration">0:00</span>
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="player-controls flex items-center justify-between w-full max-w-xs mb-8">
                    <button id="player-shuffle-btn" class="shuffle-btn text-gray-400 hover:text-white transition-colors"><i
                                class="fas fa-random text-xl"></i></button>

                    <button id="player-prev-btn" class="text-white hover:text-purple-400 transition-colors"><i
                                class="fas fa-backward-step text-3xl"></i></button>

                    <button id="player-play-pause-btn-expanded" class="w-20 h-20 rounded-full flex items-center justify-center text-3xl transform transition-transform hover:scale-105 active:scale-95" title="Play/Pause"></button>

                    <button id="player-next-btn" class="text-white hover:text-purple-400 transition-colors"><i
                                class="fas fa-forward-step text-3xl"></i></button>

                    <button id="player-repeat-btn" class="repeat-btn text-gray-400 hover:text-white transition-colors"><i
                                class="fas fa-redo text-xl"></i></button>
                </div>

                <!-- Volume -->
                <div class="flex items-center gap-4 w-full max-w-xs px-4">
                    <i class="fas fa-volume-low text-xs text-gray-500"></i>
                    <input type="range" id="player-volume-slider" class="volume-slider flex-grow" min="0" max="100" value="100">
                    <i class="fas fa-volume-high text-xs text-gray-500"></i>
                </div>
            </div>

            <!-- Queue Content -->
            <div id="queue-tab" class="tab-content w-full hidden flex-grow overflow-y-auto px-2">
                <div id="player-queue-container" class="space-y-2 pb-6"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content w-full hidden flex-grow overflow-y-auto px-4">
                <div class="space-y-6 pt-2">
                    <div class="glass-panel p-4">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 mb-4">Playback</h3>
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-medium">Crossfade</span>
                            <div class="flex items-center gap-3">
                                <input type="range" id="crossfade-slider" class="volume-slider w-24" min="0" max="10" value="0" step="0.5">
                                <span id="crossfade-value" class="text-sm font-mono w-8 text-right">0s</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Gapless
                                    Playback</span>
                            <label class="switch">
                                    <input type="checkbox"
                                        id="gapless-playback">
                                    <span class="slider"></span>
                                </label>
                        </div>
                    </div>

                    <div class="glass-panel p-4">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 mb-4">Timer</h3>
                        <div class="flex items-center gap-3">
                            <select id="sleep-timer-select" class="form-select flex-grow p-3 rounded-xl border-none">
                                    <option value="0">Timer Off</option>
                                    <option value="300">5 minutes</option>
                                    <option value="600">10 minutes</option>
                                    <option value="900">15 minutes</option>
                                    <option value="1800">30 minutes</option>
                                    <option value="3600">1 hour</option>
                                </select>
                            <button id="start-sleep-timer" class="btn-primary py-3 px-6 rounded-xl font-bold">Set</button>
                        </div>
                        <div id="sleep-timer-status" class="mt-2 text-sm text-purple-400 font-medium text-center"></div>
                    </div>

                    <div class="glass-panel p-4">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500 mb-4">Shortcuts</h3>
                        <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-400">
                            <div class="flex justify-between pr-2"><span>Play/Pause</span>
                                <kbd class="bg-white/10 px-2 rounded">Space</kbd></div>
                            <div class="flex justify-between pr-2"><span>Next</span>
                                <kbd class="bg-white/10 px-2 rounded">→</kbd></div>
                            <div class="flex justify-between pr-2"><span>Prev</span>
                                <kbd class="bg-white/10 px-2 rounded">←</kbd></div>
                            <div class="flex justify-between pr-2"><span>Vol
                                        Up</span> <kbd class="bg-white/10 px-2 rounded">↑</kbd></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white/10 backdrop-blur-xl border border-white/10 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[200] flex items-center gap-3 font-medium translate-y-[-20px]">
    </div>

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md p-6 relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">New Playlist</h2>
                <button class="modal-close w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors" id="close-create-playlist-modal">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2 font-medium" for="playlist-name">Name</label>
                    <input type="text" id="playlist-name" class="form-input w-full p-3 rounded-xl focus:outline-none" placeholder="My Awesome Mix">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2 font-medium" for="playlist-description">Description</label>
                    <textarea id="playlist-description" class="form-input w-full p-3 rounded-xl focus:outline-none" rows="3" placeholder="Vibes for late night coding..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button class="btn-secondary flex-1 py-3 rounded-xl font-medium" id="cancel-create-playlist">Cancel</button>
                <button class="btn-primary flex-1 py-3 rounded-xl font-bold" id="confirm-create-playlist">Create</button>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="add-to-playlist-modal" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add to Playlist</h2>
                <button class="modal-close w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center" id="close-add-to-playlist-modal">&times;</button>
            </div>
            <div id="playlist-options-container" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar my-4">
                <!-- Playlist options will be dynamically added here -->
            </div>
            <div class="mt-4">
                <button class="btn-secondary w-full py-3 rounded-xl font-medium" id="cancel-add-to-playlist">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu hidden absolute z-[200] min-w-[200px]">
        <div class="context-menu-item p-3 flex items-center gap-3 cursor-pointer" id="ctx-play-next">
            <i class="fas fa-forward-step w-5 text-center text-gray-400"></i>
            <span class="font-medium">Play Next</span>
        </div>
        <div class="context-menu-item p-3 flex items-center gap-3 cursor-pointer" id="ctx-play-later">
            <i class="fas fa-clock w-5 text-center text-gray-400"></i> <span class="font-medium">Play Later</span>
        </div>
        <div class="h-px bg-white/10 my-1 mx-2"></div>
        <div class="context-menu-item p-3 flex items-center gap-3 cursor-pointer" id="ctx-add-to-playlist">
            <i class="fas fa-plus-square w-5 text-center text-gray-400"></i>
            <span class="font-medium">Add to Playlist</span>
        </div>
        <div class="context-menu-item p-3 flex items-center gap-3 cursor-pointer" id="ctx-toggle-favorite">
            <i class="far fa-heart w-5 text-center text-gray-400"></i> <span class="font-medium">Favorite</span>
        </div>
        <div class="h-px bg-white/10 my-1 mx-2"></div>
        <div class="context-menu-item p-3 flex items-center gap-3 cursor-pointer hover:text-green-400" id="ctx-download">
            <i class="fas fa-download w-5 text-center text-gray-400"></i>
            <span class="font-medium">Download</span>
        </div>
    </div>

    <audio id="audio-element" class="hidden" preload="metadata"></audio>

    <!-- Original Javascript Logic -->
    <script>
        // --- Configuration & Global State ---
        // --- Advanced Preloading System ---
        const audioCache = new Map(); // Stores track_url -> Blob URL mapping
        const MAX_CACHE_SIZE = 5; // Keep last 5 songs in memory to save RAM

        async function preloadTrack(track) {
            if (!track || audioCache.has(track.track_url)) return;

            try {
                console.log(`Preloading: ${track.title}`);

                // Fetch the audio file as a binary blob
                const response = await fetch(`${API_BASE_URL}/api/download?url=${encodeURIComponent(track.track_url)}`);
                if (!response.ok) throw new Error('Network response was not ok');

                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);

                // Store in Cache
                audioCache.set(track.track_url, objectUrl);

                // Update UI to show it's cached (Optional visual feedback)
                updateQueueCacheStatus(track.track_url);

                // Manage Memory: Remove old tracks if cache gets too big
                if (audioCache.size > MAX_CACHE_SIZE) {
                    const firstKey = audioCache.keys().next().value;
                    URL.revokeObjectURL(audioCache.get(firstKey)); // Free up memory
                    audioCache.delete(firstKey);
                }
            } catch (error) {
                console.error('Preload failed:', error);
            }
        }

        // Helper to visually mark tracks as "Ready" in the queue
        function updateQueueCacheStatus(trackUrl) {
            const queueItems = document.querySelectorAll('.queue-item');
            queueItems.forEach(item => {
                // This relies on you adding data-url to queue items in Step 3
                if (item.dataset.trackUrl === trackUrl) {
                    const statusDiv = item.querySelector('.queue-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<i class="fas fa-bolt text-yellow-400" title="Instant Play"></i>';
                    }
                }
            });
        }
        const API_BASE_URL = 'https://scdlapi.yebekhe.workers.dev';
        let currentPlaylist = [];
        let originalPlaylist = []; // To restore from shuffle
        let currentTrackIndex = -1;
        let repeatMode = 'none'; // 'none', 'all', 'one'
        let isShuffle = false;
        let isDraggingProgress = false;
        let favoriteTracks = JSON.parse(localStorage.getItem('favoriteTracks') || '[]');
        let favoriteTracksData = JSON.parse(localStorage.getItem('favoriteTracksData') || '[]'); // Store track data for favorites
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let sleepTimer = null;
        let sleepTimerSeconds = 0;
        let currentTrack = null; // Store current track data
        let lastPlaylistData = null; // Store last fetched playlist data
        let lastPlayerTab = 'now-playing'; // Store last active player tab
        let currentPlaylistSource = null; // Track where the current playlist came from
        let playbackHistory = JSON.parse(localStorage.getItem('playbackHistory') || '[]');
        let playlists = JSON.parse(localStorage.getItem('playlists') || '[]');
        let queue = []; // Advanced queue management
        let crossfadeDuration = 0; // Crossfade duration in seconds
        let gaplessPlayback = false; // Gapless playback setting
        let contextMenuTrack = null; // Track for context menu operations
        let isCrossfading = false; // Flag to track crossfading state

        // --- DOM Element Helpers ---
        const G = id => document.getElementById(id);
        const audio = G('audio-element');

        // --- Utility Functions ---
        const showToast = (message, duration = 3000) => {
            const toast = G('toast');
            toast.innerHTML = `<i class="fas fa-info-circle text-purple-400"></i> ${message}`;
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, 0)';
            toast.style.pointerEvents = 'auto';

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                toast.style.pointerEvents = 'none';
            }, duration);
        };

        const formatTime = s => isNaN(s) ? '0:00' : `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`;

        const updateSearchHistory = (url) => {
            if (!url) return;
            searchHistory = searchHistory.filter(item => item !== url);
            searchHistory.unshift(url);
            if (searchHistory.length > 5) searchHistory = searchHistory.slice(0, 5);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        };

        const renderSearchHistory = () => {
            const historyContainer = G('history-container');
            const searchHistoryDiv = G('search-history');

            if (searchHistory.length === 0) {
                searchHistoryDiv.classList.add('hidden');
                return;
            }

            searchHistoryDiv.classList.remove('hidden');
            historyContainer.innerHTML = '';

            searchHistory.forEach(url => {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-full text-sm cursor-pointer transition-colors text-gray-300 truncate max-w-[200px]';
                item.textContent = url.replace('https://soundcloud.com/', '');
                item.addEventListener('click', () => {
                    G('sc-url-input').value = url;
                    handleFetch();
                });
                historyContainer.appendChild(item);
            });
        };

        // --- Playback History Management ---
        const addToPlaybackHistory = (track) => {
            playbackHistory = playbackHistory.filter(item => item.track_url !== track.track_url);
            playbackHistory.unshift({
                ...track,
                playedAt: new Date().toISOString()
            });
            if (playbackHistory.length > 50) playbackHistory = playbackHistory.slice(0, 50);
            localStorage.setItem('playbackHistory', JSON.stringify(playbackHistory));
            if (!G('history-tab').classList.contains('hidden')) renderPlaybackHistory();
        };

        const renderPlaybackHistory = () => {
            const container = G('history-tracks-container');
            container.innerHTML = '';

            if (playbackHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-12 flex flex-col items-center">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-history text-3xl opacity-50"></i>
                        </div>
                        <p class="font-medium text-lg">No playback history</p>
                    </div>
                `;
                return;
            }

            playbackHistory.forEach((track, index) => {
                const isFavorite = favoriteTracks.includes(track.track_url);
                const el = document.createElement('div');
                el.className = 'history-track-item p-3 flex items-center gap-4 group';
                el.innerHTML = `
            <div class="flex-shrink-0 relative">
                <img src="${track.thumb || ''}" class="w-12 h-12 rounded-lg bg-gray-800 object-cover">
                <div class="absolute inset-0 bg-black/40 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                    <i class="fas fa-play text-sm"></i>
                </div>
            </div>
            <div class="flex-grow min-w-0">
                <p class="font-semibold truncate text-white">${track.title}</p>
                <div class="flex items-center gap-2 text-xs text-gray-400">
                    <span class="truncate max-w-[150px]">${track.performer}</span>
                    <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                    <span>${formatPlayedDate(track.playedAt)}</span>
                </div>
            </div>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="add-to-playlist-btn w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white" title="Add to Playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="favorite-btn-history w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center ${isFavorite ? 'text-red-500' : 'text-gray-400 hover:text-red-500'}" data-url="${track.track_url}">
                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                </button>
                <a href="${API_BASE_URL}/api/download?url=${encodeURIComponent(track.track_url)}" download title="Download" class="download-btn w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white">
                    <i class="fas fa-download"></i>
                </a>
            </div>
        `;

                el.dataset.trackUrl = track.track_url;
                el.dataset.trackTitle = track.title;
                el.dataset.trackPerformer = track.performer;
                el.dataset.trackThumb = track.thumb || '';
                el.dataset.trackDuration = track.duration || '';

                el.addEventListener('click', (e) => {
                    if (e.target.closest('button') || e.target.closest('a')) return;
                    const trackData = {
                        track_url: el.dataset.trackUrl,
                        title: el.dataset.trackTitle,
                        performer: el.dataset.trackPerformer,
                        thumb: el.dataset.trackThumb,
                        duration: parseFloat(el.dataset.trackDuration) || 0
                    };
                    currentPlaylist = [trackData];
                    originalPlaylist = [trackData];
                    currentPlaylistSource = 'history';
                    playTrack(0);
                });

                el.querySelector('.add-to-playlist-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const trackData = {
                        track_url: el.dataset.trackUrl,
                        title: el.dataset.trackTitle,
                        performer: el.dataset.trackPerformer,
                        thumb: el.dataset.trackThumb,
                        duration: parseFloat(el.dataset.trackDuration) || 0
                    };
                    showAddToPlaylistModal(trackData);
                });

                el.querySelector('.favorite-btn-history').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const trackData = {
                        track_url: el.dataset.trackUrl,
                        title: el.dataset.trackTitle,
                        performer: el.dataset.trackPerformer,
                        thumb: el.dataset.trackThumb,
                        duration: parseFloat(el.dataset.trackDuration) || 0
                    };
                    toggleFavorite(trackData);
                });

                el.querySelector('.download-btn').addEventListener('click', e => e.stopPropagation());
                container.appendChild(el);
            });
        };

        const formatPlayedDate = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins/60)}h ago`;
            return date.toLocaleDateString();
        };

        const clearPlaybackHistory = () => {
            playbackHistory = [];
            localStorage.setItem('playbackHistory', JSON.stringify(playbackHistory));
            renderPlaybackHistory();
            showToast("Playback history cleared");
        };

        // --- Playlist Management ---
        const createPlaylist = (name, description = '') => {
            const newPlaylist = {
                id: Date.now().toString(),
                name,
                description,
                tracks: [],
                createdAt: new Date().toISOString()
            };
            playlists.push(newPlaylist);
            localStorage.setItem('playlists', JSON.stringify(playlists));
            if (!G('playlists-tab').classList.contains('hidden')) renderPlaylists();
            return newPlaylist;
        };

        const addTrackToPlaylist = (playlistId, track) => {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return false;
            if (playlist.tracks.some(t => t.track_url === track.track_url)) {
                showToast("Track already in playlist");
                return false;
            }
            playlist.tracks.push(track);
            localStorage.setItem('playlists', JSON.stringify(playlists));
            if (!G('playlists-tab').classList.contains('hidden')) renderPlaylists();
            showToast(`Added to ${playlist.name}`);
            return true;
        };

        const removeTrackFromPlaylist = (playlistId, trackIndex) => {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist || trackIndex < 0 || trackIndex >= playlist.tracks.length) return false;
            playlist.tracks.splice(trackIndex, 1);
            localStorage.setItem('playlists', JSON.stringify(playlists));
            if (!G('playlists-tab').classList.contains('hidden')) renderPlaylists();
            return true;
        };

        const deletePlaylist = (playlistId) => {
            playlists = playlists.filter(p => p.id !== playlistId);
            localStorage.setItem('playlists', JSON.stringify(playlists));
            if (!G('playlists-tab').classList.contains('hidden')) renderPlaylists();
            showToast("Playlist deleted");
        };

        const renderPlaylists = () => {
                const container = G('playlists-container');
                container.innerHTML = '';

                if (playlists.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state py-12 flex flex-col items-center">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-music text-3xl opacity-50"></i>
                        </div>
                        <p class="font-medium text-lg">No playlists yet</p>
                        <p class="text-sm text-gray-500 mt-2">Create a new playlist to get started</p>
                    </div>
                `;
                    return;
                }

                playlists.forEach(playlist => {
                            const el = document.createElement('div');
                            el.className = 'glass-panel p-4 hover:bg-white/5 transition-colors cursor-pointer group relative overflow-hidden';

                            // Aesthetic Background Icon
                            const bgIcon = document.createElement('i');
                            bgIcon.className = 'fas fa-compact-disc absolute -right-6 -bottom-6 text-9xl text-white/5 transform rotate-12 pointer-events-none group-hover:rotate-45 transition-transform duration-700';
                            el.appendChild(bgIcon);

                            el.innerHTML += `
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold text-lg text-white group-hover:text-purple-300 transition-colors">${playlist.name}</div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="w-8 h-8 rounded-full bg-white/10 hover:bg-purple-600 flex items-center justify-center transition-colors tooltip" data-tooltip="Play" data-playlist-id="${playlist.id}">
                            <i class="fas fa-play text-xs"></i>
                        </button>
                        <button class="w-8 h-8 rounded-full bg-white/10 hover:bg-red-500 flex items-center justify-center transition-colors tooltip" data-tooltip="Delete" data-playlist-id="${playlist.id}">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">${playlist.tracks.length} TRACKS</div>
                ${playlist.description ? `<p class="text-sm text-gray-400 line-clamp-1">${playlist.description}</p>` : ''}
            </div>
        `;

                el.dataset.playlistId = playlist.id;
                el.dataset.playlistName = playlist.name;
                el.dataset.playlistDescription = playlist.description || '';

                el.querySelector('[data-tooltip="Play"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playPlaylist(e.currentTarget.dataset.playlistId);
                });

                el.querySelector('[data-tooltip="Delete"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const playlistId = e.currentTarget.dataset.playlistId;
                    const playlistName = e.currentTarget.closest('.glass-panel').dataset.playlistName;
                    if (confirm(`Delete "${playlistName}"?`)) deletePlaylist(playlistId);
                });

                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    viewPlaylist(e.currentTarget.dataset.playlistId);
                });
                container.appendChild(el);
            });
        };

        const playPlaylist = (playlistId) => {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist || playlist.tracks.length === 0) {
                showToast("Playlist is empty");
                return;
            }
            originalPlaylist = [...playlist.tracks];
            currentPlaylist = isShuffle ? shuffleArray([...originalPlaylist]) : [...originalPlaylist];
            currentPlaylistSource = 'playlist';
            currentTrackIndex = 0;
            playTrack(0);
            showToast(`Playing ${playlist.name}`);
        };

        const viewPlaylist = (playlistId) => {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            const container = G('playlists-container');
            container.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
            <button id="back-to-playlists" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h2 class="text-2xl font-bold">${playlist.name}</h2>
                ${playlist.description ? `<p class="text-sm text-gray-400">${playlist.description}</p>` : ''}
            </div>
        </div>
        <div class="flex gap-3 mb-6">
            <button class="btn-primary flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2" id="play-playlist-btn" data-playlist-id="${playlist.id}">
                <i class="fas fa-play"></i> Play All
            </button>
            <button class="btn-secondary flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2" id="shuffle-playlist-btn" data-playlist-id="${playlist.id}">
                <i class="fas fa-random"></i> Shuffle
            </button>
        </div>
        <div class="space-y-2" id="playlist-tracks-container"></div>
    `;

            G('back-to-playlists').addEventListener('click', renderPlaylists);
            
            G('play-playlist-btn').addEventListener('click', (e) => playPlaylist(e.currentTarget.dataset.playlistId));

            G('shuffle-playlist-btn').addEventListener('click', (e) => {
                const playlistId = e.currentTarget.dataset.playlistId;
                const pl = playlists.find(p => p.id === playlistId);
                if (!pl || pl.tracks.length === 0) return;
                originalPlaylist = [...pl.tracks];
                currentPlaylist = shuffleArray([...originalPlaylist]);
                currentPlaylistSource = 'playlist';
                currentTrackIndex = 0;
                playTrack(0);
                showToast(`Shuffling ${pl.name}`);
            });

            const tracksContainer = G('playlist-tracks-container');
            playlist.tracks.forEach((track, index) => {
                const isFavorite = favoriteTracks.includes(track.track_url);
                const el = document.createElement('div');
                el.className = 'track-item p-3 flex items-center gap-3 group';
                el.innerHTML = `
            <div class="text-gray-500 font-mono text-xs w-6 text-center group-hover:hidden">${index + 1}</div>
            <div class="hidden group-hover:block w-6 text-center text-white"><i class="fas fa-play text-xs"></i></div>
            
            <img src="${track.thumb || ''}" class="w-10 h-10 rounded-lg object-cover bg-gray-800">
            
            <div class="flex-grow min-w-0">
                <p class="font-semibold truncate text-white">${track.title}</p>
                <p class="text-xs text-gray-400 truncate">${track.performer}</p>
            </div>
            
            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="remove-from-playlist-btn w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-red-500" data-playlist-id="${playlist.id}" data-index="${index}">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="favorite-btn-playlist-track w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center ${isFavorite ? 'text-red-500' : 'text-gray-400 hover:text-red-500'}" data-url="${track.track_url}">
                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                </button>
            </div>
            <div class="text-xs text-gray-500 font-mono w-10 text-right">${track.duration ? formatTime(track.duration) : ''}</div>
        `;

                el.dataset.trackUrl = track.track_url;
                el.dataset.trackTitle = track.title;
                el.dataset.trackPerformer = track.performer;
                el.dataset.trackThumb = track.thumb || '';
                el.dataset.trackDuration = track.duration || '';
                el.dataset.playlistId = playlist.id;
                el.dataset.trackIndex = index;

                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    const trackData = {
                        track_url: el.dataset.trackUrl,
                        title: el.dataset.trackTitle,
                        performer: el.dataset.trackPerformer,
                        thumb: el.dataset.trackThumb,
                        duration: parseFloat(el.dataset.trackDuration) || 0
                    };
                    originalPlaylist = [...playlist.tracks];
                    currentPlaylist = isShuffle ? shuffleArray([...originalPlaylist]) : [...originalPlaylist];
                    currentPlaylistSource = 'playlist';
                    // Find index in possibly shuffled list
                    const newIndex = currentPlaylist.findIndex(t => t.track_url === trackData.track_url);
                    playTrack(newIndex);
                });

                el.querySelector('.remove-from-playlist-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const pid = e.currentTarget.dataset.playlistId;
                    const idx = parseInt(e.currentTarget.dataset.index);
                    removeTrackFromPlaylist(pid, idx);
                    viewPlaylist(pid);
                });

                el.querySelector('.favorite-btn-playlist-track').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const trackData = {
                        track_url: el.dataset.trackUrl,
                        title: el.dataset.trackTitle,
                        performer: el.dataset.trackPerformer,
                        thumb: el.dataset.trackThumb,
                        duration: parseFloat(el.dataset.trackDuration) || 0
                    };
                    toggleFavorite(trackData);
                });

                tracksContainer.appendChild(el);
            });
        };

        // --- Queue Management ---
        const addToQueue = (track, position = 'end') => {
            if (position === 'next') {
                queue.splice(currentTrackIndex + 1, 0, track);
            } else {
                queue.push(track);
            }
            currentPlaylist = currentPlaylist.slice(0, currentTrackIndex + 1).concat(queue);
            originalPlaylist = [...currentPlaylist];
            renderPlayerQueue();
            showToast(`Added to queue ${position === 'next' ? 'next' : ''}`);
        };

        const removeFromQueue = (index) => {
            if (index < 0 || index >= queue.length) return false;
            queue.splice(index, 1);
            if (currentPlaylistSource === 'queue') {
                const playlistIndex = index + currentTrackIndex + 1;
                currentPlaylist.splice(playlistIndex, 1);
                originalPlaylist = [...currentPlaylist];
            }
            renderPlayerQueue();
            showToast("Removed from queue");
            return true;
        };

        const clearQueue = () => {
            queue = [];
            currentPlaylist = currentPlaylist.slice(0, currentTrackIndex + 1);
            originalPlaylist = [...currentPlaylist];
            renderPlayerQueue();
            showToast("Queue cleared");
        };

        function renderPlayerQueue() {
            const container = G('player-queue-container');
            if (!container) return;
            container.innerHTML = '';

            const queueControls = document.createElement('div');
            queueControls.className = 'flex justify-between items-center mb-4 sticky top-0 bg-[#09090b] py-2 z-10';
            queueControls.innerHTML = `
                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-500">Up Next</h3>
                <button id="player-clear-queue" class="text-xs text-purple-400 hover:text-white font-medium">Clear All</button>
            `;
            container.appendChild(queueControls);
            queueControls.querySelector('#player-clear-queue').addEventListener('click', () => {
                if (confirm("Clear the queue?")) clearQueue();
            });

            if (currentTrackIndex !== -1 && currentPlaylist[currentTrackIndex]) {
                const currentTrack = currentPlaylist[currentTrackIndex];
                const currentTrackEl = document.createElement('div');
                currentTrackEl.className = 'queue-item p-3 border border-purple-500/30 bg-purple-500/10 rounded-xl mb-4 flex items-center gap-3';
                currentTrackEl.innerHTML = `
            <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-purple-500 text-white animate-pulse">
                <i class="fas fa-volume-high"></i>
            </div>
            <div class="flex-grow min-w-0">
                <div class="text-purple-300 font-bold truncate">${currentTrack.title}</div>
                <div class="text-purple-400/70 text-xs truncate">${currentTrack.performer}</div>
            </div>
            <div class="text-purple-400 text-xs font-mono">PLAYING</div>
        `;
                container.appendChild(currentTrackEl);
            }

            if (queue.length === 0) {
                container.innerHTML += `
                    <div class="text-center py-8 text-gray-600">
                        <i class="fas fa-layer-group text-2xl mb-2 opacity-50"></i>
                        <p class="text-sm">Queue is empty</p>
                    </div>
                `;
                return;
            }

            const tracksContainer = document.createElement('div');
            tracksContainer.className = 'space-y-2';

            queue.forEach((track, index) => {
                const el = document.createElement('div');
                el.dataset.trackUrl = track.track_url; 
                el.className = 'queue-item p-3 flex items-center gap-3 group cursor-grab active:cursor-grabbing';
                el.draggable = true;
                el.dataset.index = index;
                const isCached = audioCache.has(track.track_url);
    const cacheIcon = isCached ? '<i class="fas fa-bolt text-yellow-400" title="Instant Play"></i>' : '';
    el.innerHTML = `
        <i class="fas fa-grip-lines text-gray-600 mr-1"></i>
        <div class="flex-grow min-w-0">
            <div class="text-white font-medium truncate">${track.title}</div>
            <div class="text-gray-500 text-xs truncate">${track.performer}</div>
        </div>
        <!-- Status Icon Container -->
        <div class="queue-status text-xs mr-2">${cacheIcon}</div>
        
        <div class="text-gray-600 text-xs font-mono mr-2">${track.duration ? formatTime(track.duration) : ''}</div>
        <button class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-500 hover:text-white transition-colors" data-tooltip="Remove" data-index="${index}">
            <i class="fas fa-times"></i>
        </button>
    `;

                el.querySelector('[data-tooltip="Remove"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromQueue(index);
                });

                // Drag Logic (Native HTML5)
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', index);
                    el.classList.add('dragging');
                });
                el.addEventListener('dragend', () => el.classList.remove('dragging'));
                el.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(el.dataset.index);
                    if (fromIndex !== toIndex) {
                        const movedTrack = queue.splice(fromIndex, 1)[0];
                        queue.splice(toIndex, 0, movedTrack);
                        currentPlaylist = currentPlaylist.slice(0, currentTrackIndex + 1).concat(queue);
                        originalPlaylist = [...currentPlaylist];
                        renderPlayerQueue();
                    }
                });

                tracksContainer.appendChild(el);
            });
            container.appendChild(tracksContainer);
        }

        // --- Crossfade and Gapless ---
        const setupCrossfade = () => {
            if (crossfadeDuration <= 0 || gaplessPlayback) return;
            const nextAudio = new Audio();
            nextAudio.volume = 0;
            nextAudio.addEventListener('canplay', () => {
                if (isCrossfading) {
                    const fadeInterval = setInterval(() => {
                        if (nextAudio.volume < 1) {
                            nextAudio.volume = Math.min(1, nextAudio.volume + 0.05);
                            audio.volume = Math.max(0, audio.volume - 0.05);
                        } else {
                            clearInterval(fadeInterval);
                            audio.pause();
                            audio.src = '';
                            // Note: Logic simplification for single file constraint - usually involves swapping audio element references
                            audio.src = nextAudio.src; 
                            audio.currentTime = nextAudio.currentTime; 
                            audio.volume = 1;
                            audio.play();
                            isCrossfading = false;
                        }
                    }, crossfadeDuration * 50);
                }
            });
            return nextAudio;
        };

        // --- Context Menu ---
        const showContextMenu = (e, track) => {
            e.preventDefault();
            contextMenuTrack = track;
            const contextMenu = G('context-menu');
            contextMenu.classList.remove('hidden');
            
            // Boundary checks
            let x = e.clientX;
            let y = e.clientY;
            if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
            if (y + 250 > window.innerHeight) y = window.innerHeight - 260;

            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;

            const isFavorite = favoriteTracks.includes(track.track_url);
            G('ctx-toggle-favorite').innerHTML = isFavorite ?
                '<i class="fas fa-heart w-5 text-center text-red-500"></i> <span class="font-medium text-red-500">Unfavorite</span>' :
                '<i class="far fa-heart w-5 text-center text-gray-400"></i> <span class="font-medium">Favorite</span>';

            document.addEventListener('click', hideContextMenu, { once: true });
        };
        const hideContextMenu = () => G('context-menu').classList.add('hidden');

        // --- API Fetch ---
        async function handleFetch() {
            const urlInput = G('sc-url-input');
            const fetchBtn = G('fetch-btn');
            const loader = G('loader');
            const errorDisplay = G('error-display');
            const playlistContainer = G('playlist-container');
            const playlistHeader = G('playlist-header');

            const scUrl = urlInput.value.trim();
            if (!scUrl) return;

            loader.classList.remove('hidden');
            errorDisplay.classList.add('hidden');
            playlistContainer.innerHTML = '';
            playlistHeader.classList.add('hidden');
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/fetch-info?url=${encodeURIComponent(scUrl)}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Request failed');
                const data = await response.json();
                lastPlaylistData = data;
                renderPlaylist(data);
                updateSearchHistory(scUrl);
            } catch (err) {
                G('error-message').textContent = err.message;
                errorDisplay.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
            }
        }

        // --- Render UI ---
        function renderPlaylist(data) {
    const playlistContainer = G('playlist-container');
    const playlistHeader = G('playlist-header');
    
    // --- FIX STARTS HERE ---
    // Clear the container before adding new items to prevent duplicates
    playlistContainer.innerHTML = ''; 
    // --- FIX ENDS HERE ---

    const isSingleTrack = data.type === 'track';
    const tracks = isSingleTrack ? [data.track] : data.tracks;
    const title = isSingleTrack ? 'Single Track' : data.title;

    playlistHeader.innerHTML = `
        <div class="flex items-center gap-3 mb-4">
            <div class="p-3 bg-purple-500/20 rounded-xl text-purple-400"><i class="fas ${isSingleTrack ? 'fa-music' : 'fa-layer-group'} text-xl"></i></div>
            <div>
                <h2 class="text-xl font-bold text-white">${title}</h2>
                <p class="text-sm text-gray-400">${tracks.length} tracks found</p>
            </div>
        </div>
    `;
    playlistHeader.classList.remove('hidden');

    tracks.forEach((track, index) => {
        const isFavorite = favoriteTracks.includes(track.track_url);
        const el = document.createElement('div');
        el.className = 'track-item p-3 flex items-center gap-4 group cursor-pointer relative overflow-hidden';
        el.innerHTML = `
    <div class="relative w-14 h-14 flex-shrink-0 group-hover:scale-105 transition-transform duration-300">
        <img src="${track.thumb || ''}" class="w-full h-full rounded-xl bg-gray-800 object-cover shadow-lg">
        <div class="absolute inset-0 bg-black/40 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity rounded-xl backdrop-blur-[1px]">
            <i class="fas fa-play"></i>
        </div>
    </div>
    <div class="flex-grow min-w-0 z-10">
        <p class="font-bold text-white truncate text-base mb-0.5">${track.title}</p>
        <p class="text-sm text-gray-400 truncate flex items-center gap-2">
            <i class="fas fa-user text-[10px]"></i> ${track.performer}
        </p>
    </div>
    <div class="flex items-center gap-2 z-10">
        <button class="favorite-btn-track w-9 h-9 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center transition-colors ${isFavorite ? 'text-red-500' : 'text-gray-400'}" data-url="${track.track_url}">
            <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
        </button>
        <a href="${API_BASE_URL}/api/download?url=${encodeURIComponent(track.track_url)}" download class="download-btn w-9 h-9 rounded-full bg-white/5 hover:bg-white/20 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-download"></i>
        </a>
    </div>
`;

        el.addEventListener('contextmenu', (e) => showContextMenu(e, track));
        el.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) return;
            originalPlaylist = [...tracks];
            currentPlaylist = isShuffle ? shuffleArray([...originalPlaylist]) : [...originalPlaylist];
            currentPlaylistSource = 'search';
            const newIndex = currentPlaylist.findIndex(t => t.track_url === track.track_url);
            playTrack(newIndex);
        });

        el.querySelector('.favorite-btn-track').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFavorite(track);
        });
        el.querySelector('.download-btn').addEventListener('click', e => e.stopPropagation());
        playlistContainer.appendChild(el);
    });
}

        function renderFavoritesTab() {
            const container = G('favorites-container');
            container.innerHTML = '';
            if (favoriteTracksData.length === 0) {
                container.innerHTML = `<div class="empty-state py-12 flex flex-col items-center"><div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4"><i class="fas fa-heart text-3xl opacity-50"></i></div><p class="font-medium text-lg">No favorites yet</p></div>`;
                return;
            }

            const playAllBtn = document.createElement('button');
            playAllBtn.className = 'w-full btn-primary py-3 rounded-xl font-bold flex items-center justify-center gap-2 mb-4';
            playAllBtn.innerHTML = '<i class="fas fa-play"></i> Play All Favorites';
            playAllBtn.addEventListener('click', playAllFavorites);
            container.appendChild(playAllBtn);

            favoriteTracksData.forEach((track, index) => {
                const el = document.createElement('div');
                el.className = 'favorite-track-item p-3 flex items-center gap-4 group cursor-pointer';
                el.innerHTML = `
            <img src="${track.thumb || ''}" class="w-12 h-12 rounded-lg bg-gray-800 object-cover">
            <div class="flex-grow min-w-0">
                <p class="font-bold text-white truncate">${track.title}</p>
                <p class="text-sm text-gray-400 truncate">${track.performer}</p>
            </div>
            <div class="flex items-center gap-2">
                 <button class="add-to-playlist-btn w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white" title="Add to Playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="remove-favorite-btn w-8 h-8 rounded-full hover:bg-red-500/20 flex items-center justify-center text-red-500" data-index="${index}">
                    <i class="fas fa-heart-crack"></i>
                </button>
            </div>
        `;
                el.addEventListener('contextmenu', (e) => showContextMenu(e, track));
                el.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    playFavoritesFromIndex(index);
                });
                el.querySelector('.add-to-playlist-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAddToPlaylistModal(track);
                });
                el.querySelector('.remove-favorite-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFavorite(index);
                });
                container.appendChild(el);
            });
        }

        // --- Logic helpers ---
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // --- Media Session API ---
// Helper: Convert URL to Blob for reliable Lock Screen Art
async function getBlobUrl(url) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        return URL.createObjectURL(blob);
    } catch (e) {
        console.warn("Failed to create blob for artwork", e);
        return url; // Fallback to original URL
    }
}
// --- Advanced Media Session ---
async function updateMediaSession(track) {
    if (!('mediaSession' in navigator)) return;

    // 1. Fix Artwork: Use local Blob instead of remote URL
    const artworkUrl = track.thumb ? await getBlobUrl(track.thumb) : '';

    navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title,
        artist: track.performer,
        album: "SoundCloud Player",
        artwork: [
            { src: artworkUrl, sizes: '96x96', type: 'image/jpeg' },
            { src: artworkUrl, sizes: '128x128', type: 'image/jpeg' },
            { src: artworkUrl, sizes: '192x192', type: 'image/jpeg' },
            { src: artworkUrl, sizes: '256x256', type: 'image/jpeg' },
            { src: artworkUrl, sizes: '384x384', type: 'image/jpeg' },
            { src: artworkUrl, sizes: '512x512', type: 'image/jpeg' },
        ]
    });

    // 2. Fix Controls: Explicit Async Handlers
    navigator.mediaSession.setActionHandler('play', async () => {
        try {
            await audio.play();
            navigator.mediaSession.playbackState = 'playing';
        } catch (e) { console.error(e); }
    });

    navigator.mediaSession.setActionHandler('pause', () => {
        audio.pause();
        navigator.mediaSession.playbackState = 'paused';
    });

    navigator.mediaSession.setActionHandler('previoustrack', () => {
        playPrev();
        // Update metadata immediately for the next track
        if('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
    });

    navigator.mediaSession.setActionHandler('nexttrack', () => {
        playNext();
        if('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
    });

    navigator.mediaSession.setActionHandler('seekto', (details) => {
        if (details.fastSeek && 'fastSeek' in audio) {
            audio.fastSeek(details.seekTime);
        } else {
            audio.currentTime = details.seekTime;
        }
        updatePositionState(); // Sync timeline immediately
    });
    
    updatePositionState();
}

// Helper to keep the lockscreen timeline synced
function updatePositionState() {
    if ('setPositionState' in navigator.mediaSession && audio.duration && !isNaN(audio.duration)) {
        navigator.mediaSession.setPositionState({
            duration: audio.duration,
            playbackRate: audio.playbackRate,
            position: audio.currentTime
        });
    }
}

        // --- Player Core ---
        const playTrack = (index) => {
            if (index < 0 || index >= currentPlaylist.length) return;
            currentTrackIndex = index;
            const track = currentPlaylist[index];
            currentTrack = track;
            addToPlaybackHistory(track);

            G('player-loading-indicator').classList.remove('hidden');
            G('player-loading-indicator-expanded').classList.remove('hidden');

            // Check if we have the song preloaded in memory
if (audioCache.has(track.track_url)) {
    console.log("Playing from instant cache ⚡");
    audio.src = audioCache.get(track.track_url);
} else {
    console.log("Streaming from network 📡");
    audio.src = `${API_BASE_URL}/api/download?url=${encodeURIComponent(track.track_url)}`;
    
    // Optional: Cache the current song while it streams (so replaying it is instant)
    preloadTrack(track); 
}
            audio.load();

            updateFavoriteButton(track.track_url);
            queue = currentPlaylist.slice(currentTrackIndex + 1);
            renderPlayerQueue();
            updatePlayerUI(track);

            audio.play().catch(e => showToast("Playback restricted. Tap play."));
            G('persistent-player-container').classList.add('show');
            highlightActiveTrack();
            
            // --- NEW: Trigger Preload for Next Track ---
    // Check if there is a next track in the playlist
    if (index + 1 < currentPlaylist.length) {
        const nextTrack = currentPlaylist[index + 1];
        // Small delay to let the current song start streaming first
        setTimeout(() => preloadTrack(nextTrack), 1000); 
    }
    // Also preload the one after that if on WiFi (optional optimization)
    if (index + 2 < currentPlaylist.length) {
        setTimeout(() => preloadTrack(currentPlaylist[index + 2]), 3000); 
    }
    updateMediaSession(track);
        };

        const playAllFavorites = () => {
            if (favoriteTracksData.length === 0) return;
            originalPlaylist = [...favoriteTracksData];
            currentPlaylist = isShuffle ? shuffleArray([...originalPlaylist]) : [...originalPlaylist];
            currentPlaylistSource = 'favorites';
            currentTrackIndex = 0;
            playTrack(0);
            showToast("Playing favorites");
        };

        const playFavoritesFromIndex = (index) => {
            if (favoriteTracksData.length === 0) return;
            originalPlaylist = [...favoriteTracksData];
            currentPlaylist = isShuffle ? shuffleArray([...originalPlaylist]) : [...originalPlaylist];
            currentPlaylistSource = 'favorites';
            const selectedTrack = favoriteTracksData[index];
            currentTrackIndex = currentPlaylist.findIndex(t => t.track_url === selectedTrack.track_url);
            playTrack(currentTrackIndex);
        };

        const playNext = () => {
            if (currentTrackIndex + 1 < currentPlaylist.length) {
                playTrack(currentTrackIndex + 1);
            } else if (repeatMode === 'one' && !isDraggingProgress) {
                audio.currentTime = 0; audio.play();
            } else if (repeatMode === 'all') {
                playTrack(0);
            } else {
                audio.pause();
                showToast("End of playlist");
            }
        };

        const playPrev = () => {
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = repeatMode === 'all' ? currentPlaylist.length - 1 : 0;
            playTrack(prevIndex);
        };

        function updatePlayerUI(track) {
            const thumb = track.thumb || '';
            G('player-thumb-mini').src = thumb;
            G('player-thumb-expanded').src = thumb;
            G('player-title-mini').textContent = track.title;
            G('player-title-expanded').textContent = track.title;
            G('player-performer-mini').textContent = track.performer;
            G('player-performer-expanded').textContent = track.performer;
            
            // Background blur for expanded player could be updated here if using dynamic colors
        }

        function setPlayPauseIcons(paused) {
            const html = paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            G('player-play-pause-btn-mini').innerHTML = html;
            G('player-play-pause-btn-expanded').innerHTML = html;
        }

        function highlightActiveTrack() {
            document.querySelectorAll('.track-item, .favorite-track-item, .history-track-item').forEach(el => el.classList.remove('active'));
            if (currentTrackIndex > -1 && currentPlaylist[currentTrackIndex]) {
                const url = currentPlaylist[currentTrackIndex].track_url;
                document.querySelectorAll(`[data-url="${url}"]`).forEach(btn => {
                    const item = btn.closest('.track-item, .favorite-track-item, .history-track-item');
                    if (item) item.classList.add('active');
                });
            }
        }

        function toggleFavorite(track) {
            const index = favoriteTracks.indexOf(track.track_url);
            const dataIndex = favoriteTracksData.findIndex(t => t.track_url === track.track_url);
            
            if (index > -1) {
                favoriteTracks.splice(index, 1);
                if (dataIndex > -1) favoriteTracksData.splice(dataIndex, 1);
                showToast("Removed from favorites");
            } else {
                favoriteTracks.push(track.track_url);
                favoriteTracksData.push(track);
                showToast("Added to favorites");
            }
            
            localStorage.setItem('favoriteTracks', JSON.stringify(favoriteTracks));
            localStorage.setItem('favoriteTracksData', JSON.stringify(favoriteTracksData));
            updateFavoriteButton(track.track_url);
            
            // Global Update
            document.querySelectorAll('.favorite-btn-track, .favorite-btn-playlist-track').forEach(btn => {
                const url = btn.getAttribute('data-url');
                const isFav = favoriteTracks.includes(url);
                btn.innerHTML = `<i class="${isFav ? 'fas' : 'far'} fa-heart"></i>`;
                btn.classList.toggle('text-red-500', isFav);
                btn.classList.toggle('text-gray-400', !isFav);
            });
            if (!G('favorites-tab').classList.contains('hidden')) renderFavoritesTab();
        }

        function removeFavorite(index) {
            const track = favoriteTracksData[index];
            if (!track) return;
            toggleFavorite(track); // reuse toggle logic
        }

        function updateFavoriteButton(trackUrl) {
            const isFavorite = favoriteTracks.includes(trackUrl);
            const html = `<i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>`;
            const miniBtn = G('player-favorite-btn-mini');
            const expBtn = G('player-favorite-btn-expanded');
            
            if (miniBtn) { miniBtn.innerHTML = html; miniBtn.classList.toggle('text-red-500', isFavorite); }
            if (expBtn) { expBtn.innerHTML = html; expBtn.classList.toggle('text-red-500', isFavorite); }
        }

        function startSleepTimer() {
            const select = G('sleep-timer-select');
            const status = G('sleep-timer-status');
            const seconds = parseInt(select.value);
            if (seconds === 0) {
                if (sleepTimer) clearInterval(sleepTimer);
                status.textContent = '';
                return;
            }
            sleepTimerSeconds = seconds;
            if (sleepTimer) clearInterval(sleepTimer);
            sleepTimer = setInterval(() => {
                sleepTimerSeconds--;
                status.textContent = `${Math.floor(sleepTimerSeconds / 60)}:${String(sleepTimerSeconds % 60).padStart(2, '0')}`;
                if (sleepTimerSeconds <= 0) {
                    clearInterval(sleepTimer);
                    audio.pause();
                    showToast("Sleep timer ended");
                    status.textContent = 'Ended';
                }
            }, 1000);
            showToast(`Timer set: ${Math.floor(seconds/60)}m`);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSearchHistory();

            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const name = tab.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                    G(`${name}-tab`).classList.remove('hidden');
                    tab.classList.add('active');
                    if (name === 'favorites') renderFavoritesTab();
                    if (name === 'search' && lastPlaylistData) renderPlaylist(lastPlaylistData);
                    if (name === 'playlists') renderPlaylists();
                    if (name === 'history') renderPlaybackHistory();
                });
            });

            G('fetch-btn').addEventListener('click', handleFetch);
            G('sc-url-input').addEventListener('keypress', e => { if (e.key === 'Enter') handleFetch(); });
            
            G('clear-history').addEventListener('click', () => {
                searchHistory = [];
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                renderSearchHistory();
            });

            G('clear-playback-history').addEventListener('click', () => {
                if(confirm("Clear playback history?")) clearPlaybackHistory();
            });

            // Modal Logic
            const toggleModal = (id, show) => G(id).classList.toggle('active', show);
            G('create-playlist-btn').addEventListener('click', () => {
                toggleModal('create-playlist-modal', true);
                G('playlist-name').value = ''; G('playlist-description').value = '';
            });
            G('close-create-playlist-modal').addEventListener('click', () => toggleModal('create-playlist-modal', false));
            G('cancel-create-playlist').addEventListener('click', () => toggleModal('create-playlist-modal', false));
            G('confirm-create-playlist').addEventListener('click', () => {
                const name = G('playlist-name').value.trim();
                const desc = G('playlist-description').value.trim();
                if (name) { createPlaylist(name, desc); toggleModal('create-playlist-modal', false); showToast("Playlist created"); }
            });
            G('close-add-to-playlist-modal').addEventListener('click', () => toggleModal('add-to-playlist-modal', false));
            G('cancel-add-to-playlist').addEventListener('click', () => toggleModal('add-to-playlist-modal', false));

            // Context Menu Items
            G('ctx-play-next').addEventListener('click', () => { if(contextMenuTrack) addToQueue(contextMenuTrack, 'next'); hideContextMenu(); });
            G('ctx-play-later').addEventListener('click', () => { if(contextMenuTrack) addToQueue(contextMenuTrack, 'end'); hideContextMenu(); });
            G('ctx-add-to-playlist').addEventListener('click', () => { if(contextMenuTrack) showAddToPlaylistModal(contextMenuTrack); hideContextMenu(); });
            G('ctx-toggle-favorite').addEventListener('click', () => { if(contextMenuTrack) toggleFavorite(contextMenuTrack); hideContextMenu(); });
            G('ctx-download').addEventListener('click', () => {
                if(contextMenuTrack) {
                    const link = document.createElement('a');
                    link.href = `${API_BASE_URL}/api/download?url=${encodeURIComponent(contextMenuTrack.track_url)}`;
                    link.download = `${contextMenuTrack.title}.mp3`;
                    link.click();
                }
                hideContextMenu();
            });

            // Player Expand/Collapse
            G('minimized-player').addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                G('persistent-player-container').classList.add('expanded');
                // Ensure correct tab logic
                const active = document.querySelector('#expanded-player .tab-button.active');
                if(active) switchPlayerTab(active.dataset.tab);
            });
            G('minimize-btn').addEventListener('click', () => G('persistent-player-container').classList.remove('expanded'));

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchPlayerTab(btn.dataset.tab));
            });
            
            function switchPlayerTab(name) {
                document.querySelectorAll('#expanded-player .tab-content').forEach(t => t.classList.add('hidden'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                G(`${name}-tab`).classList.remove('hidden');
                document.querySelector(`.tab-button[data-tab="${name}"]`).classList.add('active');
                if(name === 'queue') renderPlayerQueue();
            }

            // Player Controls
            const playPauseAction = () => {
                if (currentTrackIndex === -1 && currentPlaylist.length > 0) playTrack(0);
                else if (audio.paused) audio.play();
                else audio.pause();
            };
            G('player-play-pause-btn-mini').addEventListener('click', playPauseAction);
            G('player-play-pause-btn-expanded').addEventListener('click', playPauseAction);
            
            G('player-next-btn').addEventListener('click', playNext);
            G('player-prev-btn').addEventListener('click', playPrev);
            G('player-favorite-btn-mini').addEventListener('click', () => { if(currentTrackIndex !== -1) toggleFavorite(currentPlaylist[currentTrackIndex]); });
            G('player-favorite-btn-expanded').addEventListener('click', () => { if(currentTrackIndex !== -1) toggleFavorite(currentPlaylist[currentTrackIndex]); });
            
            G('player-share-btn').addEventListener('click', () => {
                if(currentTrackIndex !== -1) {
                    const t = currentPlaylist[currentTrackIndex];
                    if(navigator.share) navigator.share({title: t.title, text: `Listen to ${t.title}`, url: t.track_url}).catch(console.error);
                    else { navigator.clipboard.writeText(t.track_url); showToast("Link copied"); }
                }
            });

            G('player-shuffle-btn').addEventListener('click', (e) => {
                isShuffle = !isShuffle;
                e.currentTarget.classList.toggle('text-purple-400', isShuffle);
                e.currentTarget.classList.toggle('text-gray-400', !isShuffle);
                
                if (currentTrackIndex === -1) return;
                if (isShuffle) {
                    const current = currentPlaylist[currentTrackIndex];
                    const others = currentPlaylist.filter((_, i) => i !== currentTrackIndex);
                    currentPlaylist = [current, ...shuffleArray(others)];
                    currentTrackIndex = 0;
                } else {
                    const url = currentPlaylist[currentTrackIndex].track_url;
                    currentPlaylist = [...originalPlaylist];
                    currentTrackIndex = currentPlaylist.findIndex(t => t.track_url === url);
                }
                showToast(isShuffle ? "Shuffle On" : "Shuffle Off");
            });

            G('player-repeat-btn').addEventListener('click', (e) => {
                const modes = ['none', 'all', 'one'];
                repeatMode = modes[(modes.indexOf(repeatMode) + 1) % modes.length];
                const btn = e.currentTarget;
                if(repeatMode === 'none') { btn.innerHTML = '<i class="fas fa-redo"></i>'; btn.className = 'repeat-btn text-gray-400 hover:text-white transition-colors'; }
                else if(repeatMode === 'all') { btn.innerHTML = '<i class="fas fa-redo"></i>'; btn.className = 'repeat-btn text-purple-400 hover:text-purple-300 transition-colors'; }
                else { btn.innerHTML = '<div class="relative"><i class="fas fa-redo"></i><span class="absolute -top-1 -right-2 text-[8px] font-bold">1</span></div>'; btn.className = 'repeat-btn text-purple-400 hover:text-purple-300 transition-colors'; }
                showToast(`Repeat: ${repeatMode}`);
            });

            G('player-volume-slider').addEventListener('input', e => audio.volume = e.target.value / 100);
            
            // Progress Bar Logic
            const progressContainer = G('progress-container');
            const handleProgress = (e) => {
                if(!audio.duration) return;
                const rect = progressContainer.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const pos = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                audio.currentTime = pos * audio.duration;
                G('player-progress-bar').style.width = `${pos * 100}%`;
            };
            progressContainer.addEventListener('mousedown', (e) => { isDraggingProgress = true; handleProgress(e); });
            document.addEventListener('mousemove', (e) => { if(isDraggingProgress) handleProgress(e); });
            document.addEventListener('mouseup', () => isDraggingProgress = false);
            progressContainer.addEventListener('touchstart', (e) => { isDraggingProgress = true; handleProgress(e); });
            document.addEventListener('touchmove', (e) => { if(isDraggingProgress) handleProgress(e); });
            document.addEventListener('touchend', () => isDraggingProgress = false);

            G('start-sleep-timer').addEventListener('click', startSleepTimer);

            // Audio Listeners
// Audio Listeners
audio.addEventListener('play', () => { 
    setPlayPauseIcons(false); 
    renderPlayerQueue();
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
});

audio.addEventListener('pause', () => { 
    setPlayPauseIcons(true); 
    renderPlayerQueue();
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused';
});

// IMPORTANT: Keep the timeline synced
audio.addEventListener('timeupdate', () => {
    G('player-current-time').textContent = formatTime(audio.currentTime);
    if (!isDraggingProgress && audio.duration) {
        const width = `${(audio.currentTime / audio.duration) * 100}%`;
        G('player-progress-bar').style.width = width;
        const miniBar = document.getElementById('mini-progress-bar');
        if (miniBar) miniBar.style.width = width;
    }
    // Only update position state occasionally to save performance, or at end of track
    if (Math.floor(audio.currentTime) % 5 === 0) { 
        updatePositionState();
    }
});

// Sync timeline when metadata loads
audio.addEventListener('loadedmetadata', () => {
    G('player-total-duration').textContent = formatTime(audio.duration);
    G('player-loading-indicator').classList.add('hidden');
    G('player-loading-indicator-expanded').classList.add('hidden');
    updatePositionState(); // <--- Add this
});
            audio.addEventListener('ended', () => { playNext(); renderPlayerQueue(); });
            audio.addEventListener('error', () => {
                showToast("Error loading track");
                G('player-loading-indicator').classList.add('hidden');
                G('player-loading-indicator-expanded').classList.add('hidden');
            });

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if(e.key === ' ') { e.preventDefault(); playPauseAction(); }
                if(e.key === 'ArrowRight') playNext();
                if(e.key === 'ArrowLeft') playPrev();
            });

            setPlayPauseIcons(true);
        });

        function showAddToPlaylistModal(track) {
            const container = G('playlist-options-container');
            container.innerHTML = '';
            if (playlists.length === 0) {
                container.innerHTML = `<button class="btn-primary w-full py-2 rounded-lg" id="modal-create-pl-btn">Create Playlist First</button>`;
                G('modal-create-pl-btn').addEventListener('click', () => {
                    G('add-to-playlist-modal').classList.remove('active');
                    G('create-playlist-modal').classList.add('active');
                });
            } else {
                playlists.forEach(playlist => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-white/10 rounded-lg cursor-pointer flex items-center gap-2';
                    div.innerHTML = `<i class="fas fa-list"></i> ${playlist.name}`;
                    div.addEventListener('click', () => {
                        addTrackToPlaylist(playlist.id, track);
                        G('add-to-playlist-modal').classList.remove('active');
                    });
                    container.appendChild(div);
                });
            }
            G('add-to-playlist-modal').classList.add('active');
        }
    </script>
</body>

</html>
